---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# panels

<!-- badges: start -->
<!-- badges: end -->

The goal of panels is to provide tools to model panel data.

## Installation

You can install the released version of panels from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("panels")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("mateuszwyszynski/panels")
```

## Troubleshooting

1. Cannot install required packages / setup renv environment

Make sure to go through the displayed errors.
The problem might be connected to your OS environment.
E.g. you might see an information like the following:

```
Configuration failed to find one of freetype2 libpng libtiff-4 libjpeg. Try installing:
 * deb: libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev (Debian, Ubuntu, etc)
 * rpm: freetype-devel libpng-devel libtiff-devel libjpeg-devel (Fedora, CentOS, RHEL)
 * csw: libfreetype_dev libpng16_dev libtiff_dev libjpeg_dev (Solaris)
```

In such case you should first try is installing the recommended packages.
With properly configured system environment everything should work fine.

## Comparison of methods with different projection matrix

The code snippets below show a problem we currently have with the likelihood
optimization. Namely, that if we try to use the MLE parameters obtained for
one of the nested models inside the full model, we do not get the same value of
the likelihood. This is true for both the version which uses a different
projection matrix for each model (Moral-Benito version) or the version with
projection matrix constant (our version).

When looking at the output of the snippets below, the value of
`nested_no_ish_model_likelihood` should match one of the
`no_ish_model_likelihood_1` or `no_ish_model_likelihood_2`. When we get such a
result we should finally have a definite confirmation which version is correct.

### Our version

```{r}
library(magrittr)
devtools::load_all()

set.seed(23)

data_prepared <- panels::economic_growth[,1:7] %>%
  feature_standardization(timestamp_col = year, entity_col = country) %>%
  feature_standardization(timestamp_col = year, entity_col = country,
                          cross_sectional = TRUE, scale = FALSE)

nested_version_of_no_ish_model_params <- economic_growth_ms[, 15]
no_ish_model_params <-
  nested_version_of_no_ish_model_params %>% stats::na.omit()
no_ish_model_likelihood_1 <-
  SEM_likelihood(no_ish_model_params, data_prepared, year, country, gdp,
                 lin_related_regressors = c('sed', 'pgrw', 'pop'),
                 projection_matrix_const = FALSE)
no_ish_model_likelihood_2 <-
  SEM_likelihood(no_ish_model_params, data_prepared, year, country, gdp,
                 lin_related_regressors = c('sed', 'pgrw', 'pop'),
                 projection_matrix_const = TRUE)

nested_version_of_no_ish_model_params['beta_ish'] = 0
nested_version_of_no_ish_model_params['phi_1_ish'] = 0

nested_no_ish_model_likelihood <-
  SEM_likelihood(nested_version_of_no_ish_model_params, data_prepared, year,
                 country, gdp,
                 lin_related_regressors = c('ish', 'sed', 'pgrw', 'pop'),
                 projection_matrix_const = TRUE)
```

### Moral-Benito version

```{r}
library(magrittr)
devtools::load_all()

set.seed(23)

data_prepared <- panels::economic_growth[,1:7] %>%
  feature_standardization(timestamp_col = year, entity_col = country) %>%
  feature_standardization(timestamp_col = year, entity_col = country,
                          cross_sectional = TRUE, scale = FALSE)

economic_growth_ms_2 <-
  optimal_model_space(df = data_prepared, dep_var_col = gdp,
                      timestamp_col = year, entity_col = country,
                      init_value = 0.5, projection_matrix_const = FALSE)

nested_version_of_no_ish_model_params <- economic_growth_ms_2[, 15]
no_ish_model_params <-
  nested_version_of_no_ish_model_params %>% stats::na.omit()
no_ish_model_likelihood_1 <-
  SEM_likelihood(no_ish_model_params, data_prepared, year, country, gdp,
                 lin_related_regressors = c('sed', 'pgrw', 'pop'),
                 projection_matrix_const = FALSE)
no_ish_model_likelihood_2 <-
  SEM_likelihood(no_ish_model_params, data_prepared, year, country, gdp,
                 lin_related_regressors = c('sed', 'pgrw', 'pop'),
                 projection_matrix_const = TRUE)

nested_version_of_no_ish_model_params['beta_ish'] = 0
nested_version_of_no_ish_model_params['phi_1_ish'] = 0

nested_no_ish_model_likelihood <-
  SEM_likelihood(nested_version_of_no_ish_model_params, data_prepared, year,
                 country, gdp,
                 lin_related_regressors = c('ish', 'sed', 'pgrw', 'pop'),
                 projection_matrix_const = FALSE)
```
